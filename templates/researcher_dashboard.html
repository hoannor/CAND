<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Researcher Dashboard - Hệ thống Quản lý Nghiên cứu</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .navbar {
            background-color: #2c3e50;
            color: white;
        }
        .navbar-brand {
            color: white;
        }
        .main-content {
            padding: 20px;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg">
        <div class="container-fluid">
            <span class="navbar-brand">Danh sách sinh viên trong lớp</span>
            <div class="d-flex align-items-center">
                <span class="me-3 text-white" id="user-email"></span>
                <button class="btn btn-outline-light" onclick="logout()">Đăng xuất</button>
            </div>
        </div>
    </nav>

    <div class="container main-content">

        <!-- Thêm section quản lý lớp học -->
        <div id="class-management-section" class="card mb-4" style="display: none;">
            <div class="card-header">
                <h5 class="card-title mb-0">Quản lý lớp học</h5>
            </div>
            <div class="card-body">
                <!-- Thông tin lớp -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <strong>Mã lớp:</strong>
                        <span id="class-code"></span>
                    </div>
                    <div class="col-md-3">
                        <strong>Tên lớp:</strong>
                        <span id="class-name"></span>
                    </div>
                    <div class="col-md-3">
                        <strong>Năm học:</strong>
                        <span id="academic-year"></span>
                    </div>
                    <div class="col-md-3">
                        <strong>Học kỳ:</strong>
                        <span id="semester"></span>
                    </div>
                </div>

                <!-- Danh sách học sinh -->
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>STT</th>
                                <th>Họ và tên</th>
                                <th>Ngày sinh</th>
                                <th>Tỉnh</th>
                                <th>Giới tính</th>
                                <th>Ghi chú</th>
                            </tr>
                        </thead>
                        <tbody id="students-list">
                            <tr>
                                <td colspan="6" class="text-center">Đang tải dữ liệu...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            const token = localStorage.getItem('access_token');
            if (!token) {
                window.location.href = '/login';
                return;
            }

            try {
                // Kiểm tra token và lấy thông tin user
                const response = await fetch('/api/auth/me', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (!response.ok) {
                    logout();
                    return;
                }

                const userData = await response.json();
                document.getElementById('user-email').textContent = userData.email;

                // Load danh sách sinh viên
                await loadClassInfo();
                
            } catch (error) {
                console.error('Error:', error);
                showAlert('Không thể xác thực người dùng', 'danger');
                logout();
            }
        });

        function logout() {
            localStorage.removeItem('access_token');
            localStorage.removeItem('user_role');
            window.location.href = '/login';
        }

        async function loadClassInfo() {
            try {
                const response = await fetch('/api/researcher/my-class/students', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('access_token')}`
                    }
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Không thể tải thông tin lớp');
                }

                const data = await response.json();
                console.log('Class data:', data);

                // Hiển thị thông tin lớp
                document.getElementById('class-code').textContent = data.class_info.code || 'N/A';
                document.getElementById('class-name').textContent = data.class_info.name || 'N/A';
                document.getElementById('academic-year').textContent = data.class_info.academic_year || 'N/A';
                document.getElementById('semester').textContent = data.class_info.semester || 'N/A';

                // Hiển thị danh sách học sinh
                const studentsList = document.getElementById('students-list');
                if (!data.students || data.students.length === 0) {
                    studentsList.innerHTML = '<tr><td colspan="6" class="text-center">Chưa có học sinh trong lớp</td></tr>';
                } else {
                    studentsList.innerHTML = data.students.map((student, index) => `
                        <tr>
                            <td>${student.stt || (index + 1)}</td>
                            <td>${student.ho_ten || ''}</td>
                            <td>${student.ngay_sinh || ''}</td>
                            <td>${student.tinh || ''}</td>
                            <td>${student.gioi_tinh || ''}</td>
                            <td>${student.ghi_chu || ''}</td>
                        </tr>
                    `).join('');
                }

                // Hiển thị section quản lý lớp
                document.getElementById('class-management-section').style.display = 'block';
            } catch (error) {
                console.error('Error loading class info:', error);
                showAlert(error.message, 'danger');
            }
        }

        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed top-0 end-0 m-3`;
            alertDiv.style.zIndex = '9999';
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            document.body.appendChild(alertDiv);
            setTimeout(() => alertDiv.remove(), 3000);
        }
    </script>
</body>
</html> 