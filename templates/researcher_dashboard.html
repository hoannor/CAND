<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Researcher Dashboard - Hệ thống Quản lý Nghiên cứu</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .navbar {
            background-color: #2c3e50;
            color: white;
        }
        .navbar-brand {
            color: white;
        }
        .main-content {
            padding: 20px;
        }
        .table-responsive {
            margin-top: 20px;
        }
        .alert {
            z-index: 9999;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg">
        <div class="container-fluid">
            <span class="navbar-brand">Danh sách sinh viên trong lớp</span>
            <div class="d-flex align-items-center">
                <span class="me-3 text-white" id="user-email"></span>
                <button class="btn btn-outline-light" onclick="logout()">Đăng xuất</button>
            </div>
        </div>
    </nav>

    <div class="container main-content">
        <!-- Quản lý lớp học -->
        <div id="class-management-section" class="card mb-4" style="display: none;">
            <div class="card-header">
                <h5 class="card-title mb-0">Quản lý lớp học</h5>
            </div>
            <div class="card-body">
                <!-- Thông tin lớp -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <strong>Mã lớp:</strong>
                        <span id="class-code"></span>
                    </div>
                    <div class="col-md-3">
                        <strong>Tên lớp:</strong>
                        <span id="class-name"></span>
                    </div>
                    <div class="col-md-3">
                        <strong>Năm học:</strong>
                        <span id="academic-year"></span>
                    </div>
                    <div class="col-md-3">
                        <strong>Học kỳ:</strong>
                        <span id="semester"></span>
                    </div>
                </div>

                <!-- Danh sách sinh viên -->
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>STT</th>
                                <th>Student ID</th>
                                <th>Họ và tên</th>
                                <th>Ngày sinh</th>
                                <th>Tỉnh</th>
                                <th>Giới tính</th>
                                <th>Ghi chú</th>
                            </tr>
                        </thead>
                        <tbody id="students-list">
                            <tr>
                                <td colspan="7" class="text-center">Đang tải dữ liệu...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            const token = localStorage.getItem('access_token');
            if (!token) {
                window.location.href = '/login';
                return;
            }

            try {
                // Kiểm tra token và lấy thông tin user
                const userResponse = await fetch('/api/auth/me', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!userResponse.ok) {
                    throw new Error('Không thể xác thực người dùng');
                }

                const userData = await userResponse.json();
                if (userData.role !== 'researcher') {
                    throw new Error('Bạn không có quyền truy cập');
                }

                // Hiển thị email user
                document.getElementById('user-email').textContent = userData.email || 'N/A';

                // Load thông tin lớp và danh sách sinh viên
                await loadClassInfo();

            } catch (error) {
                console.error('Error:', error);
                showAlert(error.message || 'Đã xảy ra lỗi', 'danger');
                setTimeout(logout, 2000);
            }
        });

        async function loadClassInfo() {
            try {
                const token = localStorage.getItem('access_token');
                const response = await fetch('/api/researcher/my-class/students', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Không thể tải thông tin lớp');
                }

                const data = await response.json();
                console.log("API response:", data); // Debug: In toàn bộ response

                // Hiển thị thông tin lớp
                document.getElementById('class-code').textContent = data.class_info?.code || 'N/A';
                document.getElementById('class-name').textContent = data.class_info?.name || 'N/A';
                document.getElementById('academic-year').textContent = data.class_info?.academic_year || 'N/A';
                document.getElementById('semester').textContent = data.class_info?.semester || 'N/A';

                // Hiển thị danh sách sinh viên
                const studentsList = document.getElementById('students-list');
                if (!data.students || data.students.length === 0) {
                    studentsList.innerHTML = '<tr><td colspan="7" class="text-center">Chưa có học sinh trong lớp</td></tr>';
                    console.log("No students found in response.");
                } else {
                    // Debug: In danh sách sinh viên và student_ids
                    console.log("Students data:", data.students);
                    const studentIds = data.students.map(student => student._id);
                    console.log("Student IDs:", studentIds);

                    studentsList.innerHTML = data.students.map((student, index) => {
                        // Debug: In từng sinh viên để kiểm tra
                        console.log(`Student ${index + 1}:`, student);

                        return `
                            <tr>
                                <td>${index + 1}</td>
                                <td>${student._id || 'N/A'}</td>
                                <td>${student.ho_ten || student.full_name || 'N/A'}</td>
                                <td>${student.ngay_sinh || student.birth_date || 'N/A'}</td>
                                <td>${student.tinh || student.province || 'N/A'}</td>
                                <td>${student.gioi_tinh || student.gender || 'N/A'}</td>
                                <td>${student.ghi_chu || student.note || 'N/A'}</td>
                            </tr>
                        `;
                    }).join('');
                }

                // Hiển thị section quản lý lớp
                document.getElementById('class-management-section').style.display = 'block';

            } catch (error) {
                console.error('Error loading class info:', error);
                showAlert(error.message || 'Không thể tải thông tin lớp', 'danger');
            }
        }

        function logout() {
            localStorage.removeItem('access_token');
            localStorage.removeItem('user_role');
            window.location.href = '/login';
        }

        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed top-0 end-0 m-3`;
            alertDiv.style.zIndex = '9999';
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            document.body.appendChild(alertDiv);
            setTimeout(() => alertDiv.remove(), 3000);
        }
    </script>
</body>
</html>